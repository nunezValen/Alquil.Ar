{% extends 'base.html' %}
{% load static %}

{% block title %}{{ maquina.nombre }} - Alquil.ar{% endblock %}

{% block extra_head %}
<!-- CSS de Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<style>
    body {
        font-size: 16px;
    }
    h2 {
        font-size: 30px !important;
        font-weight: bold;
        margin-bottom: 1.5rem;
    }
    h2.product-title {
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    .specs-list {
        font-size: 16px;
    }
    .price {
        color: #666;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 1.5rem;
        display: block;
    }
    .machine-image {
        width: 100%;
        aspect-ratio: 1/1;
        object-fit: cover;
    }
    .image-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        background-color: #f8f9fa;
    }
    .description {
        font-size: 16px;
    }
    .specs-item {
        margin-bottom: 0.5rem;
    }
    .specs-item strong {
        margin-right: 0.5rem;
    }
    .section-container {
        max-width: 1140px;
        margin: 0 auto;
        padding: 0 15px;
    }
    .modal-content {
        border-radius: 1rem;
    }
    .modal-header {
        border-bottom: none;
        padding: 1.5rem;
    }
    .modal-body {
        padding: 1.5rem;
    }
    .modal-footer {
        border-top: none;
        padding: 1.5rem;
    }
    .form-label {
        font-weight: 500;
    }
    .form-text {
        color: #666;
    }
    .btn-close {
        position: absolute;
        right: 1rem;
        top: 1rem;
    }
    .no-disponible {
        filter: grayscale(100%);
    }
    .estado {
        margin-bottom: 1rem;
    }
    .estado-label {
        font-weight: bold;
        color: var(--color-text);
    }
    .estado-valor {
        color: var(--color-gray);
    }
    .estado-disponible {
        color: #28a745;
    }
    .estado-no-disponible {
        color: #dc3545;
    }
    
    /* Estilos personalizados para Select2 */
    .select2-container--default .select2-selection--single {
        height: 38px !important;
        border: 1px solid #ced4da !important;
        border-radius: 0.375rem !important;
        padding: 6px 12px !important;
        background-color: #fff !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 24px !important;
        color: #495057 !important;
        padding-left: 0 !important;
        padding-right: 20px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: #6c757d !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px !important;
        right: 3px !important;
    }
    
    .select2-dropdown {
        border: 1px solid #ced4da !important;
        border-radius: 0.375rem !important;
        border-top: none !important;
        border-top-left-radius: 0 !important;
        border-top-right-radius: 0 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        background-color: #fff !important;
    }
    
    .select2-container--default .select2-search--dropdown .select2-search__field {
        border: 1px solid #ced4da !important;
        border-radius: 0.375rem !important;
        padding: 6px 12px !important;
        margin: 4px !important;
        width: calc(100% - 8px) !important;
        background-color: #fff !important;
    }
    
    .select2-search--dropdown {
        background-color: #fff !important;
        padding: 4px !important;
    }
    
    .select2-container--default .select2-results__option--highlighted {
        background-color: #007bff !important;
        color: white !important;
    }
    
    .select2-container--default .select2-results__option {
        padding: 8px 12px !important;
        background-color: #fff !important;
        color: #495057 !important;
    }
    
    .select2-results__options {
        background-color: #fff !important;
    }
    
    .select2-container {
        width: 100% !important;
        display: block !important;
    }
    
    /* Ocultar el select original cuando Select2 está activo */
    .select2-cliente {
        display: none !important;
    }
    
    /* Asegurar que el container de Select2 se vea bien */
    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #80bdff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    }
</style>

<div class="section-container py-5">
    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-{{ message.tags }}{% endif %}" role="alert">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Primera sección: Imagen y detalles principales -->
    <div class="row mb-5">
        <!-- Columna izquierda: Imagen -->
        <div class="col-md-6">
            <div class="image-container">
                {% if maquina.imagen %}
                    <img src="{{ maquina.imagen.url }}" alt="{{ maquina.nombre }}" class="machine-image {% if not maquina.tiene_unidades_disponibles %}no-disponible{% endif %}">
                {% else %}
                    <img src="{% static 'img/no-image.jpg' %}" alt="Sin imagen" class="machine-image {% if not maquina.tiene_unidades_disponibles %}no-disponible{% endif %}">
                {% endif %}
            </div>
        </div>
        <!-- Columna derecha: Información principal -->
        <div class="col-md-6">
            <h2 class="product-title">{{ maquina.nombre }}</h2>
            <span class="price">${{ maquina.precio_por_dia }} por día</span>
            <div class="estado">
                <span class="estado-label">Estado:</span> <span class="estado-valor">{% if maquina.tiene_unidades_disponibles %}Disponible{% else %}No Disponible{% endif %}</span>
            </div>
            <p class="description mb-4">{{ maquina.descripcion_corta }}</p>
            <div class="d-flex gap-3">
                {% if maquina.tiene_unidades_disponibles %}
                    <button type="button" class="btn boton-principal" id="btn-alquilar">
                        Alquilar
                    </button>
                {% endif %}
                <a href="{% url 'maquinas:catalogo_publico' %}" class="btn boton-principal">Regresar al Catálogo</a>
            </div>
        </div>
    </div>

    <!-- Segunda sección: Especificaciones y Política de Cancelación -->
    <div class="row">
        <!-- Columna de Especificaciones -->
        <div class="col-md-6">
            <h2>Especificaciones</h2>
            <p class="description mb-4">{{ maquina.descripcion_larga }}</p>
            <div class="specs-list">
                <div class="specs-item">
                    <strong>Tipo:</strong>{{ maquina.get_tipo_display }}
                </div>
                <div class="specs-item">
                    <strong>Marca:</strong>{{ maquina.get_marca_display }}
                </div>
                <div class="specs-item">
                    <strong>Modelo:</strong>{{ maquina.modelo }}
                </div>
                <div class="specs-item">
                    <strong>Días mínimos de alquiler:</strong>{{ maquina.dias_alquiler_min }} días
                </div>
                <div class="specs-item">
                    <strong>Días máximos de alquiler:</strong>{{ maquina.dias_alquiler_max }} días
                </div>
            </div>
        </div>
        
        <!-- Columna de Política de Cancelación -->
        <div class="col-md-6">
            <h2>Política de Cancelación</h2>
            <div class="specs-list">
                <div class="specs-item">
                    <strong>Cancelación con reembolso total:</strong>
                    <p>Hasta {{ maquina.dias_cancelacion_total }} días antes de la fecha de inicio.</p>
                </div>
                <div class="specs-item">
                    <strong>Cancelación con reembolso parcial:</strong>
                    <p>Entre {{ maquina.dias_cancelacion_total }} y {{ maquina.dias_cancelacion_parcial }} días antes de la fecha de inicio.</p>
                    <p>Reembolso del {{ maquina.porcentaje_reembolso_parcial }}% del monto total.</p>
                </div>
                <div class="specs-item">
                    <strong>Cancelación sin reembolso:</strong>
                    <p>Menos de {{ maquina.dias_cancelacion_parcial }} días antes de la fecha de inicio.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Alquiler -->
<div class="modal fade" id="alquilerModal" tabindex="-1" aria-labelledby="alquilerModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alquilerModalLabel">Alquilar {{ maquina.nombre }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Sección de alertas -->
                <div id="modal-alerts" class="mb-3" style="display: none;"></div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <img src="{{ maquina.imagen.url }}" class="card-img-top" alt="{{ maquina.nombre }}">
                            <div class="card-body">
                                <h5 class="card-title">{{ maquina.nombre }}</h5>
                                <div class="specs-list">
                                    <p><strong>Precio por día:</strong> ${{ maquina.precio_por_dia }}</p>
                                    <p><strong>Días mínimos:</strong> {{ maquina.dias_alquiler_min }} días</p>
                                    <p><strong>Días máximos:</strong> {{ maquina.dias_alquiler_max }} días</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <form id="alquiler-form">
                            {% csrf_token %}
                            
                            <!-- Cantidad de días -->
                            <div class="mb-4">
                                <label for="dias" class="form-label">Cantidad de días</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="dias" 
                                       name="dias" 
                                       min="{{ maquina.dias_alquiler_min }}" 
                                       max="{{ maquina.dias_alquiler_max }}"
                                       value="{{ maquina.dias_alquiler_min }}"
                                       required>
                                <div class="form-text">
                                    Mínimo: {{ maquina.dias_alquiler_min }} días - Máximo: {{ maquina.dias_alquiler_max }} días
                                </div>
                            </div>

                            <!-- Fecha de inicio -->
                            <div class="mb-4">
                                <label for="fecha_inicio" class="form-label">Fecha de inicio</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="fecha_inicio" 
                                       name="fecha_inicio"
                                       min="{{ fecha_minima|date:'Y-m-d' }}"
                                       required>
                            </div>

                            <!-- Selección de cliente (solo para empleados) -->
                            <div id="cliente-selection" class="mb-4" style="display: none;">
                                <label for="cliente_id" class="form-label">Seleccionar Cliente</label>
                                <select id="cliente_id" name="cliente_id" class="form-select select2-cliente" aria-label="Seleccionar Cliente" disabled>
                                    <option value="">-- Seleccionar Cliente --</option>
                                </select>
                                <div class="form-text">
                                    Escribe para buscar por nombre, DNI o email del cliente
                                </div>
                            </div>

                            <!-- Resumen del costo -->
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Resumen del costo</h5>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Precio por día:</span>
                                        <span>${{ maquina.precio_por_dia }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Cantidad de días:</span>
                                        <span id="cantidad-dias">1</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span id="subtotal-costo">${{ maquina.precio_por_dia }}</span>
                                    </div>
                                    <!-- Información del recargo (se muestra dinámicamente) -->
                                    <div id="recargo-info" style="display: none;">
                                        <div class="d-flex justify-content-between mb-2 text-warning">
                                            <span>Recargo (<span id="porcentaje-recargo">0</span>%):</span>
                                            <span id="monto-recargo">$0</span>
                                        </div>
                                        <div class="alert alert-warning py-2 mb-2" id="mensaje-recargo">
                                            <!-- Mensaje del recargo se llenará dinámicamente -->
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>Total:</strong>
                                        <strong id="total-costo">${{ maquina.precio_por_dia }}</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Método de pago -->
                            <div class="mb-4">
                                <label class="form-label">Método de pago</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodo_pago" id="mercadopago" value="mercadopago" checked>
                                        <label class="form-check-label" for="mercadopago">
                                            <img src="{% static 'img/logo_MP.png' %}" alt="Mercado Pago" style="height: 30px; margin-right: 10px;">
                                            Mercado Pago
                                        </label>
                                    </div>
                                    
                                    {% if usuario_persona.es_empleado %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodo_pago" id="binance" value="binance">
                                        <label class="form-check-label" for="binance">
                                            <img src="{% static 'img/logo_Binance.png' %}" alt="Binance" style="height: 30px; margin-right: 10px;">
                                            Binance
                                        </label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex gap-3">
                                <button type="submit" class="btn boton-principal">Continuar con el pago</button>
                                <button type="button" class="btn boton-gris" data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de QR dinámico -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrModalLabel">Código QR para Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="qr-container" class="text-center">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Escanear para pagar:</h6>
                            <img id="qr-image" src="" alt="Código QR" class="img-fluid border" style="max-width: 250px;">
                            <p class="mt-2 text-muted small">El cliente debe escanear este código con la app de Mercado Pago</p>
                        </div>
                        <div class="col-md-6">
                            <div id="payment-details">
                                <h6>Detalles del Alquiler:</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <p><strong>Máquina:</strong> <span id="detail-maquina">{{ maquina.nombre }}</span></p>
                                        <p><strong>Cliente:</strong> <span id="detail-cliente">-</span></p>
                                        <p><strong>Fechas:</strong> <span id="detail-fechas">-</span></p>
                                        <p><strong>Total:</strong> $<span id="detail-total">-</span></p>
                                        <hr>
                                        <div id="payment-status">
                                            <div class="alert alert-info">
                                                <i class="fas fa-clock"></i> Esperando pago...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="check-payment-btn" onclick="verificarPago()">
                    <i class="fas fa-sync"></i> Verificar Pago
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de QR Binance -->
<div class="modal fade" id="binanceModal" tabindex="-1" aria-labelledby="binanceModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="binanceModalLabel">
                    <img src="{% static 'img/logo_Binance.png' %}" alt="Binance" style="height: 30px; margin-right: 10px;">
                    Pago con Binance
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Escanea el código QR para pagar:</h6>
                        <div class="text-center">
                            <img src="{% static 'img/qr_binance.jpg' %}" alt="QR Binance" class="img-fluid border rounded" style="max-width: 280px;">
                        </div>
                        <p class="mt-2 text-muted small text-center">
                            Escanea este código QR con tu app de Binance para realizar el pago
                        </p>
                    </div>
                    <div class="col-md-6">
                        <div id="binance-payment-details">
                            <h6>Detalles del Alquiler:</h6>
                            <div class="card">
                                <div class="card-body">
                                    <p><strong>Máquina:</strong> <span id="binance-detail-maquina">{{ maquina.nombre }}</span></p>
                                    <p><strong>Cliente:</strong> <span id="binance-detail-cliente">-</span></p>
                                    <p><strong>Fechas:</strong> <span id="binance-detail-fechas">-</span></p>
                                    <p><strong>Total:</strong> $<span id="binance-detail-total">-</span></p>
                                    <hr>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> 
                                        Una vez que el cliente realice el pago, confirma la transacción usando los botones de abajo.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmar-pago-binance">
                    <i class="fas fa-check"></i> Confirmar Pago
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pago Exitoso -->
<div class="modal fade" id="pagoExitosoModal" tabindex="-1" aria-labelledby="pagoExitosoModalLabel">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="pagoExitosoModalLabel">
                    <i class="fas fa-check-circle"></i> ¡Pago Exitoso!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">¡Alquiler Confirmado!</h4>
                    <div id="pago-detalles" class="mt-4">
                        <!-- Los detalles se llenarán con JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="window.location.reload()">
                    <i class="fas fa-home"></i> Continuar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const diasInput = document.getElementById('dias');
    const cantidadDiasSpan = document.getElementById('cantidad-dias');
    const totalCostoSpan = document.getElementById('total-costo');
    const precioPorDia = Number('{{ maquina.precio_por_dia }}');
    const alquilerForm = document.getElementById('alquiler-form');
    const modalAlerts = document.getElementById('modal-alerts');

    function mostrarAlerta(mensaje, tipo = 'danger') {
        modalAlerts.innerHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        modalAlerts.style.display = 'block';
        modalAlerts.scrollIntoView({ behavior: 'smooth' });
    }

    function ocultarAlertas() {
        modalAlerts.style.display = 'none';
        modalAlerts.innerHTML = '';
    }
    
    function mostrarQRDinamico(qrBase64, datos) {
        // Cerrar modal de alquiler
        alquilerModal.hide();
        
        // Llenar datos del QR modal
        document.getElementById('qr-image').src = `data:image/png;base64,${qrBase64}`;
        document.getElementById('detail-cliente').textContent = datos.cliente || '-';
        document.getElementById('detail-fechas').textContent = datos.fechas || '-';
        document.getElementById('detail-total').textContent = datos.total || '-';
        
        // Guardar external_reference para verificación
        window.currentExternalReference = datos.external_reference;
        
        // Mostrar modal de QR
        const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
        qrModal.show();
        
        // Iniciar verificación automática cada 5 segundos
        window.paymentCheckInterval = setInterval(verificarPago, 5000);
    }
    
    function mostrarQRBinance(datos) {
        // Cerrar modal de alquiler
        alquilerModal.hide();
        
        // Llenar datos del modal de Binance
        document.getElementById('binance-detail-cliente').textContent = datos.cliente || '-';
        document.getElementById('binance-detail-fechas').textContent = datos.fechas || '-';
        document.getElementById('binance-detail-total').textContent = datos.total || '-';
        
        // Guardar ID del alquiler para confirmación
        window.currentAlquilerId = datos.alquiler_id;
        
        // Mostrar modal de Binance
        const binanceModal = new bootstrap.Modal(document.getElementById('binanceModal'));
        binanceModal.show();
    }
    
    function verificarPago() {
        if (!window.currentExternalReference) return;
        
        const checkBtn = document.getElementById('check-payment-btn');
        const originalText = checkBtn.innerHTML;
        checkBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verificando...';
        checkBtn.disabled = true;
        
        fetch(`{% url 'maquinas:estado_pago_qr' %}?external_reference=${window.currentExternalReference}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.alquiler) {
                // Pago exitoso
                clearInterval(window.paymentCheckInterval);
                mostrarPagoExitoso(data.alquiler);
            } else {
                // Aún esperando pago
                console.log('Esperando pago...');
            }
        })
        .catch(error => {
            console.error('Error verificando pago:', error);
        })
        .finally(() => {
            checkBtn.innerHTML = originalText;
            checkBtn.disabled = false;
        });
    }
    
    function mostrarPagoExitoso(alquiler) {
        // Cerrar modal de QR
        const qrModal = bootstrap.Modal.getInstance(document.getElementById('qrModal'));
        if (qrModal) qrModal.hide();
        
        // Cerrar modal de Binance
        const binanceModal = bootstrap.Modal.getInstance(document.getElementById('binanceModal'));
        if (binanceModal) binanceModal.hide();
        
        // Llenar detalles del pago exitoso
        document.getElementById('pago-detalles').innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-6"><strong>Código de Retiro:</strong></div>
                        <div class="col-6"><span class="badge bg-primary fs-6">${alquiler.codigo_retiro}</span></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>Cliente:</strong></div>
                        <div class="col-6">${alquiler.cliente}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Máquina:</strong></div>
                        <div class="col-6">${alquiler.maquina}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Fechas:</strong></div>
                        <div class="col-6">${alquiler.fecha_inicio} - ${alquiler.fecha_fin}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Total Pagado:</strong></div>
                        <div class="col-6"><strong>$${alquiler.total}</strong></div>
                    </div>
                    <hr>
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Importante:</strong> Se ha enviado un email de confirmación al cliente con todos los detalles del alquiler.
                    </div>
                </div>
            </div>
        `;
        
        // Mostrar modal de pago exitoso
        const pagoExitosoModal = new bootstrap.Modal(document.getElementById('pagoExitosoModal'));
        pagoExitosoModal.show();
    }
    
    // Limpiar interval cuando se cierre el modal de QR
    document.getElementById('qrModal').addEventListener('hidden.bs.modal', function () {
        if (window.paymentCheckInterval) {
            clearInterval(window.paymentCheckInterval);
        }
    });

    function actualizarCosto() {
        const dias = parseInt(diasInput.value);
        const subtotal = dias * precioPorDia;
        const clienteId = document.getElementById('cliente_id').value;
        

        
        // Actualizar cantidad de días y subtotal
        cantidadDiasSpan.textContent = dias;
        document.getElementById('subtotal-costo').textContent = '$' + subtotal.toFixed(2);
        
        // Calcular recargo si hay un cliente seleccionado o si es un cliente normal
        let total = subtotal;
        const recargoInfo = document.getElementById('recargo-info');
        let cliente = null;
        
        // Determinar qué cliente usar para el cálculo
        if (clienteId && window.clientesData && window.clientesData[clienteId]) {
            // Empleado ha seleccionado un cliente
            cliente = window.clientesData[clienteId];
        } else if (window.clienteActual) {
            // Cliente normal haciendo su propio alquiler
            cliente = window.clienteActual;
        }
        
        if (cliente) {
            if (cliente.tiene_recargo) {
                // Calcular recargo según las reglas de negocio
                let porcentaje;
                if (cliente.calificacion_promedio >= 4.0) {
                    porcentaje = 0;
                } else if (cliente.calificacion_promedio >= 3.0) {
                    porcentaje = 10;
                } else if (cliente.calificacion_promedio >= 2.0) {
                    porcentaje = 20;
                } else {
                    porcentaje = 30;
                }
                const montoRecargo = (subtotal * porcentaje) / 100;
                total = subtotal + montoRecargo;
                

                
                // Mostrar información del recargo
                document.getElementById('porcentaje-recargo').textContent = porcentaje;
                document.getElementById('monto-recargo').textContent = '$' + montoRecargo.toFixed(2);
                document.getElementById('mensaje-recargo').innerHTML = 
                    `<i class="fas fa-exclamation-triangle me-2"></i>` +
                    `Se aplica recargo por calificación promedio de ${cliente.calificacion_promedio} estrellas.`;
                recargoInfo.style.display = 'block';
            } else {
                // Sin recargo
                recargoInfo.style.display = 'none';
            }
        } else {
            // Sin cliente, ocultar recargo
            recargoInfo.style.display = 'none';
        }
        
        // Actualizar total
        totalCostoSpan.textContent = '$' + total.toFixed(2);
    }

    diasInput.addEventListener('change', actualizarCosto);
    
    // Agregar evento para cambio de cliente
    document.getElementById('cliente_id').addEventListener('change', actualizarCosto);
    
    actualizarCosto();

    // Instancia del modal para manejo consistente
    const alquilerModal = new bootstrap.Modal(document.getElementById('alquilerModal'));
    
    // Verificar al abrir el modal si el usuario puede alquilar
    const btnAlquilar = document.getElementById('btn-alquilar');
    if (btnAlquilar) {
        btnAlquilar.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Limpiar alertas previas
            ocultarAlertas();
            
            // Verificar estado del usuario antes de abrir el modal
            fetch(`{% url 'maquinas:alquilar_maquina' maquina.id %}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.tiene_alquiler_activo) {
                    // Mostrar modal con alerta
                    alquilerModal.show();
                    
                    setTimeout(() => {
                        mostrarAlerta(
                            '<i class="fas fa-exclamation-triangle me-2"></i>' +
                            '<strong>No puedes alquilar en este momento</strong><br>' +
                            'Ya existe un alquiler activo asociado a esta persona.' +
                            'Antes de realizar un nuevo alquiler debe de finalizar o cancelar el actual ',
                            'warning'
                        );
                    }, 300);
                } else {
                    // Poblar lista de clientes si es empleado
                    if (data.clientes && data.clientes.length > 0) {
                        const clienteSelect = document.getElementById('cliente_id');
                        const clienteSection = document.getElementById('cliente-selection');
                        
                        // Almacenar datos de clientes globalmente para cálculo de recargo
                        window.clientesData = {};
                        
                        // Limpiar opciones existentes
                        clienteSelect.innerHTML = '<option value="">-- Seleccionar Cliente --</option>';
                        
                        // Agregar todas las opciones de clientes
                        data.clientes.forEach(cliente => {
                            const option = document.createElement('option');
                            option.value = cliente.id;
                            option.textContent = `${cliente.nombre} ${cliente.apellido} - DNI: ${cliente.dni} - ${cliente.email}`;
                            if (cliente.tiene_recargo) {
                                option.textContent += ` ⚠️ (Recargo aplicable)`;
                            }
                            clienteSelect.appendChild(option);
                            
                            // Almacenar datos del cliente para cálculo de recargo
                            window.clientesData[cliente.id] = cliente;
                        });
                        
                        // Inicializar Select2 cuando jQuery esté disponible
                        if (typeof $ !== 'undefined') {
                            $('.select2-cliente').select2({
                                placeholder: "Escribir para buscar cliente...",
                                allowClear: true,
                                dropdownParent: $('#alquilerModal'),
                                width: '100%',
                                minimumInputLength: 0,
                                language: {
                                    noResults: function() {
                                        return "No se encontraron clientes";
                                    },
                                    searching: function() {
                                        return "Buscando...";
                                    },
                                    inputTooShort: function() {
                                        return "Escriba para buscar...";
                                    }
                                }
                            });
                            
                            // Agregar evento para Select2
                            $('.select2-cliente').on('select2:select', function (e) {
                                actualizarCosto();
                            });
                            
                            $('.select2-cliente').on('select2:clear', function (e) {
                                actualizarCosto();
                            });
                        } else {
                            // Fallback: usar setTimeout para esperar a que jQuery se cargue
                            setTimeout(function() {
                                if (typeof $ !== 'undefined') {
                                    $('.select2-cliente').select2({
                                        placeholder: "Escribir para buscar cliente...",
                                        allowClear: true,
                                        dropdownParent: $('#alquilerModal'),
                                        width: '100%',
                                        minimumInputLength: 0,
                                        language: {
                                            noResults: function() {
                                                return "No se encontraron clientes";
                                            },
                                            searching: function() {
                                                return "Buscando...";
                                            },
                                            inputTooShort: function() {
                                                return "Escriba para buscar...";
                                            }
                                        }
                                    });
                                    
                                    // Agregar evento para Select2
                                    $('.select2-cliente').on('select2:select', function (e) {
                                        actualizarCosto();
                                    });
                                    
                                    $('.select2-cliente').on('select2:clear', function (e) {
                                        actualizarCosto();
                                    });
                                }
                            }, 100);
                        }
                        
                        // Mostrar sección de clientes y habilitar el campo
                        clienteSection.style.display = 'block';
                        document.getElementById('cliente_id').disabled = false;
                    }
                    
                    // Usuario puede alquilar, mostrar modal normalmente
                    alquilerModal.show();
                    
                    // Si no es empleado, obtener datos del cliente actual para recargo
                    if (!data.clientes || data.clientes.length === 0) {
                        // Es un cliente normal, obtener sus datos para calcular recargo
                        fetch('/persona/obtener-datos-cliente-actual/', {
                            method: 'GET',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                        .then(response => response.json())
                        .then(clienteData => {
                            if (clienteData.success && clienteData.cliente) {
                                // Almacenar datos del cliente actual
                                window.clienteActual = clienteData.cliente;
                                // Actualizar costo con datos del cliente
                                actualizarCosto();
                            }
                        })
                        .catch(error => {
                            console.error('Error obteniendo datos del cliente:', error);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error al verificar estado:', error);
                // En caso de error, mostrar el modal normalmente
                alquilerModal.show();
            });
        });
    }
    
    // Asegurar que las alertas se limpien cuando el modal se cierre
    document.getElementById('alquilerModal').addEventListener('hidden.bs.modal', function () {
        ocultarAlertas();
        // Limpiar Select2 si existe
        if (typeof $ !== 'undefined' && $('.select2-cliente').length > 0) {
            $('.select2-cliente').val(null).trigger('change');
        }
        // Ocultar y deshabilitar sección de clientes
        const clienteSection = document.getElementById('cliente-selection');
        const clienteSelect = document.getElementById('cliente_id');
        if (clienteSection) {
            clienteSection.style.display = 'none';
        }
        if (clienteSelect) {
            clienteSelect.disabled = true;
        }
        // Restaurar aria-hidden cuando el modal se cierre
        this.setAttribute('aria-hidden', 'true');
    });
    
    // Manejar aria-hidden cuando el modal se muestre
    document.getElementById('alquilerModal').addEventListener('shown.bs.modal', function () {
        this.removeAttribute('aria-hidden');
    });
    
    // Manejar aria-hidden para el modal de QR
    document.getElementById('qrModal').addEventListener('shown.bs.modal', function () {
        this.removeAttribute('aria-hidden');
    });
    
    document.getElementById('qrModal').addEventListener('hidden.bs.modal', function () {
        this.setAttribute('aria-hidden', 'true');
    });
    
    // Manejar aria-hidden para el modal de pago exitoso
    document.getElementById('pagoExitosoModal').addEventListener('shown.bs.modal', function () {
        this.removeAttribute('aria-hidden');
    });
    
    document.getElementById('pagoExitosoModal').addEventListener('hidden.bs.modal', function () {
        this.setAttribute('aria-hidden', 'true');
    });
    
    // Manejar aria-hidden para el modal de Binance
    document.getElementById('binanceModal').addEventListener('shown.bs.modal', function () {
        this.removeAttribute('aria-hidden');
    });
    
    document.getElementById('binanceModal').addEventListener('hidden.bs.modal', function () {
        this.setAttribute('aria-hidden', 'true');
    });
    
    // Manejar confirmación de pago de Binance
    document.getElementById('confirmar-pago-binance').addEventListener('click', function() {
        if (!window.currentAlquilerId) {
            alert('Error: No se encontró el ID del alquiler');
            return;
        }
        
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Confirmando...';
        
        // Enviar confirmación al servidor
        fetch('{% url "maquinas:confirmar_pago_binance" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                alquiler_id: window.currentAlquilerId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cerrar modal de Binance
                const binanceModal = bootstrap.Modal.getInstance(document.getElementById('binanceModal'));
                binanceModal.hide();
                
                // Mostrar modal de éxito
                mostrarPagoExitoso(data.alquiler);
            } else {
                alert('Error al confirmar el pago: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al confirmar el pago');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    });

    alquilerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Limpiar alertas previas
        ocultarAlertas();
        
        // Mostrar spinner de carga
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
        
        const formData = new FormData(this);
        
        // Si el campo de cliente está deshabilitado, no incluirlo en el FormData
        const clienteSelect = document.getElementById('cliente_id');
        if (clienteSelect && clienteSelect.disabled) {
            formData.delete('cliente_id');
        }
        
        const alquilerUrl = `{% url 'maquinas:alquilar_maquina' maquina.id %}`;
        
        fetch(alquilerUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                let icono = '<i class="fas fa-exclamation-circle me-2"></i>';
                let tipo = 'danger';
                
                // Personalizar según el tipo de error
                if (data.error.includes('ya tienes un alquiler activo')) {
                    icono = '<i class="fas fa-exclamation-triangle me-2"></i>';
                    tipo = 'warning';
                } else if (data.error.includes('no hay unidades disponibles')) {
                    icono = '<i class="fas fa-calendar-times me-2"></i>';
                    tipo = 'info';
                }
                
                mostrarAlerta(icono + '<strong>Error:</strong> ' + data.error, tipo);
                
                // Restaurar botón
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            } else if (data.qr_code_base64) {
                // EMPLEADO: Mostrar QR dinámico
                const clienteSelect = document.getElementById('cliente_id');
                const clienteNombre = clienteSelect.options[clienteSelect.selectedIndex].text;
                const fechaInicio = document.getElementById('fecha_inicio').value;
                const dias = parseInt(document.getElementById('dias').value);
                const fechaFin = new Date(fechaInicio);
                fechaFin.setDate(fechaFin.getDate() + dias - 1);
                
                const datosQR = {
                    cliente: clienteNombre,
                    fechas: `${fechaInicio} - ${fechaFin.toISOString().split('T')[0]}`,
                    total: document.getElementById('total-costo').textContent.replace('$', ''),
                    external_reference: data.external_reference
                };
                
                mostrarQRDinamico(data.qr_code_base64, datosQR);
                
                // Restaurar botón
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            } else if (data.metodo_pago === 'binance') {
                // EMPLEADO: Mostrar QR estático de Binance
                const clienteSelect = document.getElementById('cliente_id');
                const clienteNombre = clienteSelect.options[clienteSelect.selectedIndex].text;
                const fechaInicio = document.getElementById('fecha_inicio').value;
                const dias = parseInt(document.getElementById('dias').value);
                const fechaFin = new Date(fechaInicio);
                fechaFin.setDate(fechaFin.getDate() + dias - 1);
                
                mostrarQRBinance({
                    cliente: clienteNombre,
                    fechas: `${fechaInicio} - ${fechaFin.toISOString().split('T')[0]}`,
                    total: document.getElementById('total-costo').textContent.replace('$', ''),
                    alquiler_id: data.alquiler_id
                });
                
                // Restaurar botón
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            } else if (data.init_point) {
                // CLIENTE: Redirigir a Mercado Pago
                window.location.href = data.init_point;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta(
                '<i class="fas fa-times-circle me-2"></i>' +
                '<strong>Error de conexión:</strong> No se pudo procesar el pago. Por favor, intente nuevamente.',
                'danger'
            );
            // Restaurar botón
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    });
});
</script>

<!-- JS de Select2 y jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %} 